<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<meta name="referrer" content="no-referrer">
<title>(译) Uber Go 风格指南 - Jovan&#39;s Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js"></script>




    <meta name="description" content="Uber 是一家美国硅谷的科技公司,也是 Go 语言的早期 adopter。其开源了很多 golang 项目,诸如被 Gopher 圈熟知的 zap、jaeger 等。2018 年年末 Uber 将内部的 Go 风格规范 开源到 GitHub,经过一年的积累和更新,该规范已经初具规模,并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。">
<meta property="og:type" content="article">
<meta property="og:title" content="(译) Uber Go 风格指南">
<meta property="og:url" content="https://www.ulovecode.com/2020/04/05/Go/Golang%E8%AF%91%E6%96%87/Uber-Go-%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="Jovan&#39;s Blog">
<meta property="og:description" content="Uber 是一家美国硅谷的科技公司,也是 Go 语言的早期 adopter。其开源了很多 golang 项目,诸如被 Gopher 圈熟知的 zap、jaeger 等。2018 年年末 Uber 将内部的 Go 风格规范 开源到 GitHub,经过一年的积累和更新,该规范已经初具规模,并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static001.infoq.cn/resource/image/2f/0f/2fcb88dd7848dcdc7ad73c75ad5a880f.jpg">
<meta property="article:published_time" content="2020-04-05T00:38:00.000Z">
<meta property="article:modified_time" content="2020-04-05T00:38:00.000Z">
<meta property="article:author" content="Jovan">
<meta property="article:tag" content="编程规范">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static001.infoq.cn/resource/image/2f/0f/2fcb88dd7848dcdc7ad73c75ad5a880f.jpg">







    <link rel="icon" href="//md.ulovecode.com/static/images/avatar/logo.jpg">

<link rel="stylesheet" href="https://code.bdstatic.com/npm/bulma@0.7.5/css/bulma.min.css">
<link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.8.1/css/all.min.css">
<!--<link rel="stylesheet" href="https://fonts.proxy.ustclug.org/css?family=Noto+Serif+SC:500|Source+Code+Pro:500&display=swap">-->

 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.6.0/style.css" />
 
<!-- <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/lxgwwenkaiscreen.css"> -->

<link rel="stylesheet" href="https://code.bdstatic.com/npm/highlight.js@10.1.0/styles/github.css">


    
        
    
        
    
    <link rel="stylesheet" href="https://code.bdstatic.com/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://code.bdstatic.com/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
        

<link rel="stylesheet" href="https://code.bdstatic.com/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
        
    
        

<link rel="stylesheet" href="/css/back-to-top.css">


    
        

    
        
    
        

    
        
    
        
    

    
        
    


<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="//md.ulovecode.com/static/images/avatar/logo.jpg" alt="(译) Uber Go 风格指南" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ulovecode">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-image">
        <span  class="image is-7by1">
            <img class="thumbnail" src="https://static001.infoq.cn/resource/image/2f/0f/2fcb88dd7848dcdc7ad73c75ad5a880f.jpg" alt="(译) Uber Go 风格指南">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-04-05T00:38:00.000Z">2020-04-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Go/">Go</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Go/Golang%E8%AF%91%E6%96%87/">Golang译文</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 10805 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                (译) Uber Go 风格指南
            
        </h1>
        <div class="content">
            <!--

Editing this document:

- Discuss all changes in GitHub issues first.
- Update the table of contents as new sections are added or removed.
- Use tables for side-by-side code samples. See below.

Code Samples:

Use 2 spaces to indent. Horizontal real estate is important in side-by-side
samples.

For side-by-side code samples, use the following snippet.

<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`Bad` vs `Good`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```go</span><br><span class="line">BAD CODE GOES HERE</span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```go</span><br><span class="line">GOOD CODE GOES HERE</span><br><span class="line">```</span><br></pre></td></tr></table></figure>
<p>(You need the empty lines between the  and code samples for it to be<br>treated as Markdown.)</p>
<p>If you need to add labels or descriptions below the code samples, add another<br>row before the  line.</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">DESCRIBE</span> <span class="keyword">BAD </span><span class="meta">CODE</span></span><br><span class="line"><span class="symbol">DESCRIBE</span> GOOD <span class="meta">CODE</span></span><br></pre></td></tr></table></figure>
<p>–&gt;</p>
<!--
change.md

# 2019-12-17
- 函数选项：推荐 “Option” 接口的结构实现
- 而不是用闭包捕获值。

# 2019-11-26
- 添加针对全局变量变异的指导。

# 2020-01-11
- 为`open（..）`调用添加缺少的参数。

# 2020-02-03
- 使用`"time"`处理时间的建议
- 添加有关在公共结构中嵌入类型的指导。

# 2020-02-25
- 添加有关接口验证是否符合编译时检查的指导。

-->
<p><a href="https://www.uber.com/" target="_blank" rel="noopener">Uber</a> 是一家美国硅谷的科技公司,也是 Go 语言的早期 adopter。其开源了很多 golang 项目,诸如被 Gopher 圈熟知的 <a href="https://github.com/uber-go/zap" target="_blank" rel="noopener">zap</a>、<a href="https://github.com/jaegertracing/jaeger" target="_blank" rel="noopener">jaeger</a> 等。2018 年年末 Uber 将内部的 <a href="https://github.com/uber-go/guide" target="_blank" rel="noopener">Go 风格规范</a> 开源到 GitHub,经过一年的积累和更新,该规范已经初具规模,并受到广大 Gopher 的关注。本文是该规范的中文版本。本版本会根据原版实时更新。</p>
<a id="more"></a>
<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><ul>
<li>当前更新版本：2020-02-25 版本地址：<a href="https://github.com/uber-go/guide/commit/ccf37611cb2e7771addf820745641f8fbc76b2cb" target="_blank" rel="noopener">commit:#86</a></li>
<li>如果您发现任何更新、问题或改进,请随时 fork 和 PR</li>
<li>Please feel free to fork and PR if you find any updates, issues or improvement.</li>
</ul>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#介绍">介绍</a></li>
<li><a href="#指导原则">指导原则</a><ul>
<li><a href="#指向-interface-的指针">指向 interface 的指针</a></li>
<li><a href="#interface-合理性验证">Interface 合理性验证</a></li>
<li><a href="#接收器-receiver-与接口">接收器 (receiver) 与接口</a></li>
<li><a href="#零值-Mutex-是有效的">零值 Mutex 是有效的</a></li>
<li><a href="#在边界处拷贝-Slices-和-Maps">在边界处拷贝 Slices 和 Maps</a></li>
<li><a href="#使用-defer-释放资源">使用 defer 释放资源</a></li>
<li><a href="#Channel-的-size-要么是-1要么是无缓冲的">Channel 的 size 要么是 1,要么是无缓冲的</a></li>
<li><a href="#枚举从-1-开始">枚举从 1 开始</a></li>
<li><a href="#使用-time-处理时间">使用<code>&quot;time&quot;</code>处理时间</a></li>
<li><a href="#错误类型">错误类型</a></li>
<li><a href="#错误包装-error-wrapping">错误包装 (Error Wrapping)</a></li>
<li><a href="#处理类型断言失败">处理类型断言失败</a></li>
<li><a href="#不要-panic">不要 panic</a></li>
<li><a href="#使用-gouberorgatomic">使用 go.uber.org/atomic</a></li>
<li><a href="#避免可变全局变量">避免可变全局变量</a></li>
<li><a href="#避免在公共结构中嵌入类型">避免在公共结构中嵌入类型</a></li>
</ul>
</li>
<li><a href="#性能">性能</a><ul>
<li><a href="#优先使用-strconv-而不是-fmt">优先使用 strconv 而不是 fmt</a></li>
<li><a href="#避免字符串到字节的转换">避免字符串到字节的转换</a></li>
<li><a href="#尽量初始化时指定-Map-容量">尽量初始化时指定 Map 容量</a></li>
</ul>
</li>
<li><a href="#规范">规范</a><ul>
<li><a href="#一致性">一致性</a></li>
<li><a href="#相似的声明放在一组">相似的声明放在一组</a></li>
<li><a href="#import-分组">import 分组</a></li>
<li><a href="#包名">包名</a></li>
<li><a href="#函数名">函数名</a></li>
<li><a href="#导入别名">导入别名</a></li>
<li><a href="#函数分组与顺序">函数分组与顺序</a></li>
<li><a href="#减少嵌套">减少嵌套</a></li>
<li><a href="#不必要的-else">不必要的 else</a></li>
<li><a href="#顶层变量声明">顶层变量声明</a></li>
<li><a href="#对于未导出的顶层常量和变量使用_作为前缀">对于未导出的顶层常量和变量,使用_作为前缀</a></li>
<li><a href="#结构体中的嵌入">结构体中的嵌入</a></li>
<li><a href="#使用字段名初始化结构体">使用字段名初始化结构体</a></li>
<li><a href="#本地变量声明">本地变量声明</a></li>
<li><a href="#nil-是一个有效的-slice">nil 是一个有效的 slice</a></li>
<li><a href="#小变量作用域">小变量作用域</a></li>
<li><a href="#避免参数语义不明确Avoid-Naked-Parameters">避免参数语义不明确（Avoid Naked Parameters）</a></li>
<li><a href="#使用原始字符串字面值避免转义">使用原始字符串字面值,避免转义</a></li>
<li><a href="#初始化-Struct-引用">初始化 Struct 引用</a></li>
<li><a href="#初始化-maps">初始化 Maps</a></li>
<li><a href="#字符串-string-format">字符串 string format </a></li>
<li><a href="#命名-Printf-样式的函数">命名 Printf 样式的函数</a></li>
</ul>
</li>
<li><a href="#编程模式">编程模式</a><ul>
<li><a href="#表驱动测试">表驱动测试</a></li>
<li><a href="#功能选项">功能选项</a></li>
</ul>
</li>
</ul>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>样式 (style) 是支配我们代码的惯例。术语<code>样式</code>有点用词不当,因为这些约定涵盖的范围不限于由 gofmt 替我们处理的源文件格式。</p>
<p>本指南的目的是通过详细描述在 Uber 编写 Go 代码的注意事项来管理这种复杂性。这些规则的存在是为了使代码库易于管理,同时仍然允许工程师更有效地使用 Go 语言功能。</p>
<p>该指南最初由 <a href="https://github.com/prashantv" target="_blank" rel="noopener">Prashant Varanasi</a> 和 <a href="https://github.com/nomis52" target="_blank" rel="noopener">Simon Newton</a> 编写,目的是使一些同事能快速使用 Go。多年来,该指南已根据其他人的反馈进行了修改。</p>
<p>本文档记录了我们在 Uber 遵循的 Go 代码中的惯用约定。其中许多是 Go 的通用准则,而其他扩展准则依赖于下面外部的指南：</p>
<ol>
<li><a href="https://golang.org/doc/effective_go.html" target="_blank" rel="noopener">Effective Go</a></li>
<li><a href="https://github.com/golang/go/wiki/CodeReviewComments" target="_blank" rel="noopener">The Go common mistakes guide</a></li>
</ol>
<p>所有代码都应该通过<code>golint</code>和<code>go vet</code>的检查并无错误。我们建议您将编辑器设置为：</p>
<ul>
<li>保存时运行<code>goimports</code></li>
<li>运行<code>golint</code>和<code>go vet</code>检查错误</li>
</ul>
<p>您可以在以下 Go 编辑器工具支持页面中找到更为详细的信息：<br><a href="https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins" target="_blank" rel="noopener">https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins</a></p>
<h2 id="指导原则"><a href="#指导原则" class="headerlink" title="指导原则"></a>指导原则</h2><h3 id="指向-interface-的指针"><a href="#指向-interface-的指针" class="headerlink" title="指向 interface 的指针"></a>指向 interface 的指针</h3><p>您几乎不需要指向接口类型的指针。您应该将接口作为值进行传递,在这样的传递过程中,实质上传递的底层数据仍然可以是指针。</p>
<p>接口实质上在底层用两个字段表示：</p>
<ol>
<li>一个指向某些特定类型信息的指针。您可以将其视为”type”。</li>
<li>数据指针。如果存储的数据是指针,则直接存储。如果存储的数据是一个值,则存储指向该值的指针。</li>
</ol>
<p>如果希望接口方法修改基础数据,则必须使用指针传递。</p>
<h3 id="Interface-合理性验证"><a href="#Interface-合理性验证" class="headerlink" title="Interface 合理性验证"></a>Interface 合理性验证</h3><p>在编译时验证接口的符合性。这包括：</p>
<ul>
<li>将实现特定接口所需的导出类型作为其 API 的一部分</li>
<li>导出或未导出的类型是实现同一接口的类型集合的一部分</li>
<li>其他违反接口的情况会破坏用户。</li>
</ul>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Handler <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *Handler)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  w http.ResponseWriter,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  r *http.Request,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">)</span></span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Handler <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-keyword">var</span> _ http.Handler = (*Handler)(<span class="hljs-literal">nil</span>)</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *Handler)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  w http.ResponseWriter,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  r *http.Request,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">)</span></span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>*Handler</code>永远不会与<code>http.Handler</code>接口匹配,那么语句<code>var _ http.Handler = (*Handler)(nil)</code>将无法编译</p>
<p>赋值的右边应该是断言类型的零值。对于指针类型（如<code>*Handler</code>）、切片和映射,这是<code>nil</code>；对于结构类型,这是空结构。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> LogHandler <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  h   http.Handler</span><br><span class="line">  log *zap.Logger</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-keyword">var</span> _ http.Handler = LogHandler&#123;&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h LogHandler)</span> <span class="hljs-title">ServeHTTP</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  w http.ResponseWriter,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  r *http.Request,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">)</span></span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接收器-receiver-与接口"><a href="#接收器-receiver-与接口" class="headerlink" title="接收器 (receiver) 与接口"></a>接收器 (receiver) 与接口</h3><p>使用值接收器的方法既可以通过值调用,也可以通过指针调用。</p>
<p>例如,</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> S <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  data <span class="hljs-keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s S)</span> <span class="hljs-title">Read</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> s.data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *S)</span> <span class="hljs-title">Write</span><span class="hljs-params">(str <span class="hljs-keyword">string</span>)</span></span> &#123;</span><br><span class="line">  s.data = str</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sVals := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]S&#123;<span class="hljs-number">1</span>: &#123;<span class="hljs-string">"A"</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 你只能通过值调用 Read</span></span><br><span class="line">sVals[<span class="hljs-number">1</span>].Read()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 这不能编译通过：</span></span><br><span class="line"><span class="hljs-comment">//  sVals[1].Write("test")</span></span><br><span class="line"></span><br><span class="line">sPtrs := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]*S&#123;<span class="hljs-number">1</span>: &#123;<span class="hljs-string">"A"</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 通过指针既可以调用 Read,也可以调用 Write 方法</span></span><br><span class="line">sPtrs[<span class="hljs-number">1</span>].Read()</span><br><span class="line">sPtrs[<span class="hljs-number">1</span>].Write(<span class="hljs-string">"test"</span>)</span><br></pre></td></tr></table></figure>
<p>同样,即使该方法具有值接收器,也可以通过指针来满足接口。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> F <span class="hljs-keyword">interface</span> &#123;</span><br><span class="line">  f()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> S1 <span class="hljs-keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s S1)</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> S2 <span class="hljs-keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *S2)</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">s1Val := S1&#123;&#125;</span><br><span class="line">s1Ptr := &amp;S1&#123;&#125;</span><br><span class="line">s2Val := S2&#123;&#125;</span><br><span class="line">s2Ptr := &amp;S2&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> i F</span><br><span class="line">i = s1Val</span><br><span class="line">i = s1Ptr</span><br><span class="line">i = s2Ptr</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//  下面代码无法通过编译。因为 s2Val 是一个值,而 S2 的 f 方法中没有使用值接收器</span></span><br><span class="line"><span class="hljs-comment">//   i = s2Val</span></span><br></pre></td></tr></table></figure>
<p><a href="https://golang.org/doc/effective_go.html" target="_blank" rel="noopener">Effective Go</a> 中有一段关于 <a href="https://golang.org/doc/effective_go.html#pointers_vs_values" target="_blank" rel="noopener">pointers vs. values</a> 的精彩讲解。</p>
<h3 id="零值-Mutex-是有效的"><a href="#零值-Mutex-是有效的" class="headerlink" title="零值 Mutex 是有效的"></a>零值 Mutex 是有效的</h3><p>零值<code>sync.Mutex</code>和<code>sync.RWMutex</code>是有效的。所以指向 mutex 的指针基本是不必要的。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mu := <span class="hljs-built_in">new</span>(sync.Mutex)</span><br><span class="line">mu.Lock()</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> mu sync.Mutex</span><br><span class="line">mu.Lock()</span><br></pre></td></tr></table></figure>
<p>如果你使用结构体指针,mutex 可以非指针形式作为结构体的组成字段,或者更好的方式是直接嵌入到结构体中。<br>如果是私有结构体类型或是要实现 Mutex 接口的类型,我们可以使用嵌入 mutex 的方法：</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> smap <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  sync.Mutex <span class="hljs-comment">// only for unexported types（仅适用于非导出类型）</span></span><br><span class="line"></span><br><span class="line">  data <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newSMap</span><span class="hljs-params">()</span> *<span class="hljs-title">smap</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> &amp;smap&#123;</span><br><span class="line">    data: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *smap)</span> <span class="hljs-title">Get</span><span class="hljs-params">(k <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  m.Lock()</span><br><span class="line">  <span class="hljs-keyword">defer</span> m.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> m.data[k]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> SMap <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  mu sync.Mutex <span class="hljs-comment">// 对于导出类型,请使用私有锁</span></span><br><span class="line"></span><br><span class="line">  data <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSMap</span><span class="hljs-params">()</span> *<span class="hljs-title">SMap</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> &amp;SMap&#123;</span><br><span class="line">    data: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *SMap)</span> <span class="hljs-title">Get</span><span class="hljs-params">(k <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  m.mu.Lock()</span><br><span class="line">  <span class="hljs-keyword">defer</span> m.mu.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> m.data[k]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为私有类型或需要实现互斥接口的类型嵌入。<br>对于导出的类型,请使用专用字段。</p>
<h3 id="在边界处拷贝-Slices-和-Maps"><a href="#在边界处拷贝-Slices-和-Maps" class="headerlink" title="在边界处拷贝 Slices 和 Maps"></a>在边界处拷贝 Slices 和 Maps</h3><p>slices 和 maps 包含了指向底层数据的指针,因此在需要复制它们时要特别注意。</p>
<h4 id="接收-Slices-和-Maps"><a href="#接收-Slices-和-Maps" class="headerlink" title="接收 Slices 和 Maps"></a>接收 Slices 和 Maps</h4><p>请记住,当 map 或 slice 作为函数参数传入时,如果您存储了对它们的引用,则用户可以对其进行修改。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Driver)</span> <span class="hljs-title">SetTrips</span><span class="hljs-params">(trips []Trip)</span></span> &#123;</span><br><span class="line">  d.trips = trips</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trips := ...</span><br><span class="line">d1.SetTrips(trips)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 你是要修改 d1.trips 吗？</span></span><br><span class="line">trips[<span class="hljs-number">0</span>] = ...</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *Driver)</span> <span class="hljs-title">SetTrips</span><span class="hljs-params">(trips []Trip)</span></span> &#123;</span><br><span class="line">  d.trips = <span class="hljs-built_in">make</span>([]Trip, <span class="hljs-built_in">len</span>(trips))</span><br><span class="line">  <span class="hljs-built_in">copy</span>(d.trips, trips)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trips := ...</span><br><span class="line">d1.SetTrips(trips)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 这里我们修改 trips[0],但不会影响到 d1.trips</span></span><br><span class="line">trips[<span class="hljs-number">0</span>] = ...</span><br></pre></td></tr></table></figure>
<h4 id="返回-slices-或-maps"><a href="#返回-slices-或-maps" class="headerlink" title="返回 slices 或 maps"></a>返回 slices 或 maps</h4><p>同样,请注意用户对暴露内部状态的 map 或 slice 的修改。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Stats <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  mu sync.Mutex</span><br><span class="line"></span><br><span class="line">  counters <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Snapshot 返回当前状态。</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stats)</span> <span class="hljs-title">Snapshot</span><span class="hljs-params">()</span> <span class="hljs-title">map</span>[<span class="hljs-title">string</span>]<span class="hljs-title">int</span></span> &#123;</span><br><span class="line">  s.mu.Lock()</span><br><span class="line">  <span class="hljs-keyword">defer</span> s.mu.Unlock()</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> s.counters</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// snapshot 不再受互斥锁保护</span></span><br><span class="line"><span class="hljs-comment">// 因此对 snapshot 的任何访问都将受到数据竞争的影响</span></span><br><span class="line"><span class="hljs-comment">// 影响 stats.counters</span></span><br><span class="line">snapshot := stats.Snapshot()</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Stats <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  mu sync.Mutex</span><br><span class="line"></span><br><span class="line">  counters <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Stats)</span> <span class="hljs-title">Snapshot</span><span class="hljs-params">()</span> <span class="hljs-title">map</span>[<span class="hljs-title">string</span>]<span class="hljs-title">int</span></span> &#123;</span><br><span class="line">  s.mu.Lock()</span><br><span class="line">  <span class="hljs-keyword">defer</span> s.mu.Unlock()</span><br><span class="line"></span><br><span class="line">  result := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">int</span>, <span class="hljs-built_in">len</span>(s.counters))</span><br><span class="line">  <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> s.counters &#123;</span><br><span class="line">    result[k] = v</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// snapshot 现在是一个拷贝</span></span><br><span class="line">snapshot := stats.Snapshot()</span><br></pre></td></tr></table></figure>
<h3 id="使用-defer-释放资源"><a href="#使用-defer-释放资源" class="headerlink" title="使用 defer 释放资源"></a>使用 defer 释放资源</h3><p>使用 defer 释放资源,诸如文件和锁。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">p.Lock()</span><br><span class="line"><span class="hljs-keyword">if</span> p.count &lt; <span class="hljs-number">10</span> &#123;</span><br><span class="line">  p.Unlock()</span><br><span class="line">  <span class="hljs-keyword">return</span> p.count</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p.count++</span><br><span class="line">newCount := p.count</span><br><span class="line">p.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> newCount</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 当有多个 return 分支时,很容易遗忘 unlock</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p.Lock()</span><br><span class="line"><span class="hljs-keyword">defer</span> p.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> p.count &lt; <span class="hljs-number">10</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> p.count</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p.count++</span><br><span class="line"><span class="hljs-keyword">return</span> p.count</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 更可读</span></span><br></pre></td></tr></table></figure>
<p>Defer 的开销非常小,只有在您可以证明函数执行时间处于纳秒级的程度时,才应避免这样做。使用 defer 提升可读性是值得的,因为使用它们的成本微不足道。尤其适用于那些不仅仅是简单内存访问的较大的方法,在这些方法中其他计算的资源消耗远超过<code>defer</code>。</p>
<h3 id="Channel-的-size-要么是-1-要么是无缓冲的"><a href="#Channel-的-size-要么是-1-要么是无缓冲的" class="headerlink" title="Channel 的 size 要么是 1,要么是无缓冲的"></a>Channel 的 size 要么是 1,要么是无缓冲的</h3><p>channel 通常 size 应为 1 或是无缓冲的。默认情况下,channel 是无缓冲的,其 size 为零。任何其他尺寸都必须经过严格的审查。我们需要考虑如何确定大小,考虑是什么阻止了 channel 在高负载下和阻塞写时的写入,以及当这种情况发生时系统逻辑有哪些变化。(翻译解释：按照原文意思是需要界定通道边界,竞态条件,以及逻辑上下文梳理)</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 应该足以满足任何情况！</span></span><br><span class="line">c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-number">64</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 大小：1</span></span><br><span class="line">c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// 或者</span></span><br><span class="line"><span class="hljs-comment">// 无缓冲 channel,大小为 0</span></span><br><span class="line">c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span><br></pre></td></tr></table></figure>
<h3 id="枚举从-1-开始"><a href="#枚举从-1-开始" class="headerlink" title="枚举从 1 开始"></a>枚举从 1 开始</h3><p>在 Go 中引入枚举的标准方法是声明一个自定义类型和一个使用了 iota 的 const 组。由于变量的默认值为 0,因此通常应以非零值开头枚举。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Operation <span class="hljs-keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  Add Operation = <span class="hljs-literal">iota</span></span><br><span class="line">  Subtract</span><br><span class="line">  Multiply</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Add=0, Subtract=1, Multiply=2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Operation <span class="hljs-keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  Add Operation = <span class="hljs-literal">iota</span> + <span class="hljs-number">1</span></span><br><span class="line">  Subtract</span><br><span class="line">  Multiply</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Add=1, Subtract=2, Multiply=3</span></span><br></pre></td></tr></table></figure>
<p>在某些情况下,使用零值是有意义的（枚举从零开始）,例如,当零值是理想的默认行为时。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> LogOutput <span class="hljs-keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  LogToStdout LogOutput = <span class="hljs-literal">iota</span></span><br><span class="line">  LogToFile</span><br><span class="line">  LogToRemote</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// LogToStdout=0, LogToFile=1, LogToRemote=2</span></span><br></pre></td></tr></table></figure>
<h3 id="使用-time-处理时间"><a href="#使用-time-处理时间" class="headerlink" title="使用 time 处理时间"></a>使用 time 处理时间</h3><p>时间处理很复杂。关于时间的错误假设通常包括以下几点。</p>
<ol>
<li>一天有 24 小时</li>
<li>一小时有 60 分钟</li>
<li>一周有七天</li>
<li>一年 365 天</li>
<li><a href="https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time" target="_blank" rel="noopener">还有更多</a></li>
</ol>
<p>例如,<em>1</em> 表示在一个时间点上加上 24 小时并不总是产生一个新的日历日。</p>
<p>因此,在处理时间时始终使用 <a href="https://golang.org/pkg/time/" target="_blank" rel="noopener"><code>&quot;time&quot;</code></a> 包,因为它有助于以更安全、更准确的方式处理这些不正确的假设。</p>
<h4 id="使用time-Time表达瞬时时间"><a href="#使用time-Time表达瞬时时间" class="headerlink" title="使用time.Time表达瞬时时间"></a>使用<code>time.Time</code>表达瞬时时间</h4><p>在处理时间的瞬间时使用 <a href="https://golang.org/pkg/time/#Time" target="_blank" rel="noopener"><code>time.time</code></a>,在比较、添加或减去时间时使用<code>time.Time</code>中的方法。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isActive</span><span class="hljs-params">(now, start, stop <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> start &lt;= now &amp;&amp; now &lt; stop</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isActive</span><span class="hljs-params">(now, start, stop time.Time)</span> <span class="hljs-title">bool</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> (start.Before(now) || start.Equal(now)) &amp;&amp; now.Before(stop)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用time-Duration表达时间段"><a href="#使用time-Duration表达时间段" class="headerlink" title="使用time.Duration表达时间段"></a>使用<code>time.Duration</code>表达时间段</h4><p>在处理时间段时使用 <a href="https://golang.org/pkg/time/#Duration" target="_blank" rel="noopener"><code>time.Duration</code></a> .</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">poll</span><span class="hljs-params">(delay <span class="hljs-keyword">int</span>)</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">for</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">    time.Sleep(time.Duration(delay) * time.Millisecond)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">poll(<span class="hljs-number">10</span>) <span class="hljs-comment">// 是几秒钟还是几毫秒?</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">poll</span><span class="hljs-params">(delay time.Duration)</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">for</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// ...</span></span><br><span class="line">    time.Sleep(delay)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">poll(<span class="hljs-number">10</span>*time.Second)</span><br></pre></td></tr></table></figure>
<p>回到第一个例子,在一个时间瞬间加上 24 小时,我们用于添加时间的方法取决于意图。如果我们想要下一个日历日(当前天的下一天)的同一个时间点,我们应该使用 <a href="https://golang.org/pkg/time/#Time.AddDate" target="_blank" rel="noopener"><code>Time.AddDate</code></a>。但是,如果我们想保证某一时刻比前一时刻晚 24 小时,我们应该使用 <a href="https://golang.org/pkg/time/#Time.Add" target="_blank" rel="noopener"><code>Time.Add</code></a>。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">newDay := t.AddDate(<span class="hljs-number">0</span> <span class="hljs-comment">/* years */</span>, <span class="hljs-number">0</span>, <span class="hljs-comment">/* months */</span>, <span class="hljs-number">1</span> <span class="hljs-comment">/* days */</span>)</span><br><span class="line">maybeNewDay := t.Add(<span class="hljs-number">24</span> * time.Hour)</span><br></pre></td></tr></table></figure>
<h4 id="对外部系统使用time-Time和time-Duration"><a href="#对外部系统使用time-Time和time-Duration" class="headerlink" title="对外部系统使用time.Time和time.Duration"></a>对外部系统使用<code>time.Time</code>和<code>time.Duration</code></h4><p>尽可能在与外部系统的交互中使用<code>time.Duration</code>和<code>time.Time</code>例如 :</p>
<ul>
<li>Command-line 标志: <a href="https://golang.org/pkg/flag/" target="_blank" rel="noopener"><code>flag</code></a> 通过 <a href="https://golang.org/pkg/time/#ParseDuration" target="_blank" rel="noopener"><code>time.ParseDuration</code></a> 支持<code>time.Duration</code></li>
<li>JSON: <a href="https://golang.org/pkg/encoding/json/" target="_blank" rel="noopener"><code>encoding/json</code></a> 通过其 <a href="https://golang.org/pkg/time/#Time.UnmarshalJSON" target="_blank" rel="noopener"><code>UnmarshalJSON</code>method</a> 方法支持将<code>time.Time</code>编码为 <a href="https://tools.ietf.org/html/rfc3339" target="_blank" rel="noopener">RFC 3339</a> 字符串</li>
<li>SQL: <a href="https://golang.org/pkg/database/sql/" target="_blank" rel="noopener"><code>database/sql</code></a> 支持将<code>DATETIME</code>或<code>TIMESTAMP</code>列转换为<code>time.Time</code>,如果底层驱动程序支持则返回</li>
<li>YAML: <a href="https://godoc.org/gopkg.in/yaml.v2" target="_blank" rel="noopener"><code>gopkg.in/yaml.v2</code></a> 支持将<code>time.Time</code>作为 <a href="https://tools.ietf.org/html/rfc3339" target="_blank" rel="noopener">RFC 3339</a> 字符串,并通过 <a href="https://golang.org/pkg/time/#ParseDuration" target="_blank" rel="noopener"><code>time.ParseDuration</code></a> 支持<code>time.Duration</code>。</li>
</ul>
<p>当不能在这些交互中使用<code>time.Duration</code>时,请使用<code>int</code>或<code>float64</code>,并在字段名称中包含单位。</p>
<p>例如,由于<code>encoding/json</code>不支持<code>time.Duration</code>,因此该单位包含在字段的名称中。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// &#123;"interval": 2&#125;</span></span><br><span class="line"><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  Interval <span class="hljs-keyword">int</span><span class="hljs-string">`json:"interval"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// &#123;"intervalMillis": 2000&#125;</span></span><br><span class="line"><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  IntervalMillis <span class="hljs-keyword">int</span><span class="hljs-string">`json:"intervalMillis"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当在这些交互中不能使用<code>time.Time</code>时,除非达成一致,否则使用<code>string</code>和 <a href="https://tools.ietf.org/html/rfc3339" target="_blank" rel="noopener">RFC 3339</a> 中定义的格式时间戳。默认情况下,<a href="https://golang.org/pkg/time/#Time.UnmarshalText" target="_blank" rel="noopener"><code>Time.UnmarshalText</code></a> 使用此格式,并可通过 <a href="https://golang.org/pkg/time/#RFC3339" target="_blank" rel="noopener"><code>time.RFC3339</code></a> 在<code>Time.Format</code>和<code>time.Parse</code>中使用。</p>
<p>尽管这在实践中并不成问题,但请记住,<code>&quot;time&quot;</code>包不支持解析闰秒时间戳（<a href="https://github.com/golang/go/issues/8728" target="_blank" rel="noopener">8728</a>）,也不在计算中考虑闰秒（<a href="https://github.com/golang/go/issues/15190" target="_blank" rel="noopener">15190</a>）。如果您比较两个时间瞬间,则差异将不包括这两个瞬间之间可能发生的闰秒。</p>
<!-- TODO: section on String methods for enums -->
<h3 id="错误类型"><a href="#错误类型" class="headerlink" title="错误类型"></a>错误类型</h3><p>Go 中有多种声明错误（Error) 的选项：</p>
<ul>
<li><a href="https://golang.org/pkg/errors/#New" target="_blank" rel="noopener"><code>errors.New</code></a> 对于简单静态字符串的错误</li>
<li><a href="https://golang.org/pkg/fmt/#Errorf" target="_blank" rel="noopener"><code>fmt.Errorf</code></a> 用于格式化的错误字符串</li>
<li>实现<code>Error()</code>方法的自定义类型</li>
<li>用 <a href="https://godoc.org/github.com/pkg/errors#Wrap" target="_blank" rel="noopener"><code>&quot;pkg/errors&quot;.Wrap</code></a> 的 Wrapped errors</li>
</ul>
<p>返回错误时,请考虑以下因素以确定最佳选择：</p>
<ul>
<li>这是一个不需要额外信息的简单错误吗？如果是这样,<a href="https://golang.org/pkg/errors/#New" target="_blank" rel="noopener"><code>errors.New</code></a> 足够了。</li>
<li>客户需要检测并处理此错误吗？如果是这样,则应使用自定义类型并实现该<code>Error()</code>方法。</li>
<li>您是否正在传播下游函数返回的错误？如果是这样,请查看本文后面有关错误包装 <a href="#错误包装 (Error-Wrapping">section on error wrapping</a>) 部分的内容。</li>
<li>否则 <a href="https://golang.org/pkg/fmt/#Errorf" target="_blank" rel="noopener"><code>fmt.Errorf</code></a> 就可以了。</li>
</ul>
<p>如果客户端需要检测错误,并且您已使用创建了一个简单的错误 <a href="https://golang.org/pkg/errors/#New" target="_blank" rel="noopener"><code>errors.New</code></a>,请使用一个错误变量。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// package foo</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Open</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"could not open"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// package bar</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">use</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> err := foo.Open(); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"could not open"</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// handle</span></span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-built_in">panic</span>(<span class="hljs-string">"unknown error"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// package foo</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> ErrCouldNotOpen = errors.New(<span class="hljs-string">"could not open"</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Open</span><span class="hljs-params">()</span> <span class="hljs-title">error</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> ErrCouldNotOpen</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// package bar</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> err := foo.Open(); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> err == foo.ErrCouldNotOpen &#123;</span><br><span class="line">    <span class="hljs-comment">// handle</span></span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">panic</span>(<span class="hljs-string">"unknown error"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果您有可能需要客户端检测的错误,并且想向其中添加更多信息（例如,它不是静态字符串）,则应使用自定义类型。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">open</span><span class="hljs-params">(file <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"file %q not found"</span>, file)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">use</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> err := open(<span class="hljs-string">"testfile.txt"</span>); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> strings.Contains(err.Error(), <span class="hljs-string">"not found"</span>) &#123;</span><br><span class="line">      <span class="hljs-comment">// handle</span></span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-built_in">panic</span>(<span class="hljs-string">"unknown error"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> errNotFound <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  file <span class="hljs-keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e errNotFound)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"file %q not found"</span>, e.file)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">open</span><span class="hljs-params">(file <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> errNotFound&#123;file: file&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">use</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> err := open(<span class="hljs-string">"testfile.txt"</span>); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> _, ok := err.(errNotFound); ok &#123;</span><br><span class="line">      <span class="hljs-comment">// handle</span></span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-built_in">panic</span>(<span class="hljs-string">"unknown error"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接导出自定义错误类型时要小心,因为它们已成为程序包公共 API 的一部分。最好公开匹配器功能以检查错误。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// package foo</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> errNotFound <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  file <span class="hljs-keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e errNotFound)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"file %q not found"</span>, e.file)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IsNotFoundError</span><span class="hljs-params">(err error)</span> <span class="hljs-title">bool</span></span> &#123;</span><br><span class="line">  _, ok := err.(errNotFound)</span><br><span class="line">  <span class="hljs-keyword">return</span> ok</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Open</span><span class="hljs-params">(file <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> errNotFound&#123;file: file&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// package bar</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> err := foo.Open(<span class="hljs-string">"foo"</span>); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> foo.IsNotFoundError(err) &#123;</span><br><span class="line">    <span class="hljs-comment">// handle</span></span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">panic</span>(<span class="hljs-string">"unknown error"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- TODO: Exposing the information to callers with accessor functions. -->
<h3 id="错误包装-Error-Wrapping"><a href="#错误包装-Error-Wrapping" class="headerlink" title="错误包装 (Error Wrapping)"></a>错误包装 (Error Wrapping)</h3><p>一个（函数/方法）调用失败时,有三种主要的错误传播方式：</p>
<ul>
<li>如果没有要添加的其他上下文,并且您想要维护原始错误类型,则返回原始错误。</li>
<li><p>添加上下文,使用 <a href="https://godoc.org/github.com/pkg/errors#Wrap" target="_blank" rel="noopener"><code>&quot;pkg/errors&quot;.Wrap</code></a> 以便错误消息提供更多上下文 ,<a href="https://godoc.org/github.com/pkg/errors#Cause" target="_blank" rel="noopener"><code>&quot;pkg/errors&quot;.Cause</code></a> 可用于提取原始错误。<br>Use fmt.Errorf if the callers do not need to detect or handle that specific error case.</p>
</li>
<li><p>如果调用者不需要检测或处理的特定错误情况,使用 <a href="https://golang.org/pkg/fmt/#Errorf" target="_blank" rel="noopener"><code>fmt.Errorf</code></a>。</p>
</li>
</ul>
<p>建议在可能的地方添加上下文,以使您获得诸如“调用服务 foo：连接被拒绝”之类的更有用的错误,而不是诸如“连接被拒绝”之类的模糊错误。</p>
<p>在将上下文添加到返回的错误时,请避免使用“failed to”之类的短语来保持上下文简洁,这些短语会陈述明显的内容,并随着错误在堆栈中的渗透而逐渐堆积：</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s, err := store.New()</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> fmt.Errorf(</span><br><span class="line">        <span class="hljs-string">"failed to create new store: %s"</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s, err := store.New()</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> fmt.Errorf(</span><br><span class="line">        <span class="hljs-string">"new store: %s"</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight livecodeserver hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed <span class="hljs-built_in">to</span> x: failed <span class="hljs-built_in">to</span> y: failed <span class="hljs-built_in">to</span> <span class="hljs-built_in">create</span> <span class="hljs-built_in">new</span> store: <span class="hljs-keyword">the</span> error</span><br></pre></td></tr></table></figure>
<figure class="highlight groovy hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">x:</span> <span class="hljs-string">y:</span> <span class="hljs-keyword">new</span> <span class="hljs-string">store:</span> the error</span><br></pre></td></tr></table></figure>
<p>但是,一旦将错误发送到另一个系统,就应该明确消息是错误消息（例如使用<code>err</code>标记,或在日志中以”Failed”为前缀）。</p>
<p>另请参见 <a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully" target="_blank" rel="noopener">Don’t just check errors, handle them gracefully</a>. 不要只是检查错误,要优雅地处理错误</p>
<h3 id="处理类型断言失败"><a href="#处理类型断言失败" class="headerlink" title="处理类型断言失败"></a>处理类型断言失败</h3><p><a href="https://golang.org/ref/spec#Type_assertions" target="_blank" rel="noopener">type assertion</a> 的单个返回值形式针对不正确的类型将产生 panic。因此,请始终使用“comma ok”的惯用法。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t := i.(<span class="hljs-keyword">string</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t, ok := i.(<span class="hljs-keyword">string</span>)</span><br><span class="line"><span class="hljs-keyword">if</span> !ok &#123;</span><br><span class="line">  <span class="hljs-comment">// 优雅地处理错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- TODO: There are a few situations where the single assignment form is
fine. -->
<h3 id="不要-panic"><a href="#不要-panic" class="headerlink" title="不要 panic"></a>不要 panic</h3><p>在生产环境中运行的代码必须避免出现 panic。panic 是 <a href="https://en.wikipedia.org/wiki/Cascading_failure" target="_blank" rel="noopener">cascading failures</a> 级联失败的主要根源 。如果发生错误,该函数必须返回错误,并允许调用方决定如何处理它。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foo</span><span class="hljs-params">(bar <span class="hljs-keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(bar) == <span class="hljs-number">0</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">panic</span>(<span class="hljs-string">"bar must not be empty"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(os.Args) != <span class="hljs-number">2</span> &#123;</span><br><span class="line">    fmt.Println(<span class="hljs-string">"USAGE: foo &lt;bar&gt;"</span>)</span><br><span class="line">    os.Exit(<span class="hljs-number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  foo(os.Args[<span class="hljs-number">1</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foo</span><span class="hljs-params">(bar <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(bar) == <span class="hljs-number">0</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">"bar must not be empty"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(os.Args) != <span class="hljs-number">2</span> &#123;</span><br><span class="line">    fmt.Println(<span class="hljs-string">"USAGE: foo &lt;bar&gt;"</span>)</span><br><span class="line">    os.Exit(<span class="hljs-number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">if</span> err := foo(os.Args[<span class="hljs-number">1</span>]); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">panic</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>panic/recover 不是错误处理策略。仅当发生不可恢复的事情（例如：nil 引用）时,程序才必须 panic。程序初始化是一个例外：程序启动时应使程序中止的不良情况可能会引起 panic。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> _statusTemplate = template.Must(template.New(<span class="hljs-string">"name"</span>).Parse(<span class="hljs-string">"_statusHTML"</span>))</span><br></pre></td></tr></table></figure>
<p>即使在测试代码中,也优先使用<code>t.Fatal</code>或者<code>t.FailNow</code>而不是 panic 来确保失败被标记。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// func TestFoo(t *testing.T)</span></span><br><span class="line"></span><br><span class="line">f, err := ioutil.TempFile(<span class="hljs-string">""</span>, <span class="hljs-string">"test"</span>)</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">  <span class="hljs-built_in">panic</span>(<span class="hljs-string">"failed to set up test"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// func TestFoo(t *testing.T)</span></span><br><span class="line"></span><br><span class="line">f, err := ioutil.TempFile(<span class="hljs-string">""</span>, <span class="hljs-string">"test"</span>)</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">  t.Fatal(<span class="hljs-string">"failed to set up test"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<!-- TODO: Explain how to use _test packages. -->
<h3 id="使用-go-uber-org-atomic"><a href="#使用-go-uber-org-atomic" class="headerlink" title="使用 go.uber.org/atomic"></a>使用 go.uber.org/atomic</h3><p>使用 <a href="https://golang.org/pkg/sync/atomic/" target="_blank" rel="noopener">sync/atomic</a> 包的原子操作对原始类型 (<code>int32</code>,<code>int64</code>等）进行操作,因为很容易忘记使用原子操作来读取或修改变量。</p>
<p><a href="https://godoc.org/go.uber.org/atomic" target="_blank" rel="noopener">go.uber.org/atomic</a> 通过隐藏基础类型为这些操作增加了类型安全性。此外,它包括一个方便的<code>atomic.Bool</code>类型。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> foo <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  running <span class="hljs-keyword">int32</span>  <span class="hljs-comment">// atomic</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f* foo)</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> atomic.SwapInt32(&amp;f.running, <span class="hljs-number">1</span>) == <span class="hljs-number">1</span> &#123;</span><br><span class="line">     <span class="hljs-comment">// already running…</span></span><br><span class="line">     <span class="hljs-keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-comment">// start the Foo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *foo)</span> <span class="hljs-title">isRunning</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> f.running == <span class="hljs-number">1</span>  <span class="hljs-comment">// race!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> foo <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  running atomic.Bool</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *foo)</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> f.running.Swap(<span class="hljs-literal">true</span>) &#123;</span><br><span class="line">     <span class="hljs-comment">// already running…</span></span><br><span class="line">     <span class="hljs-keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-comment">// start the Foo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *foo)</span> <span class="hljs-title">isRunning</span><span class="hljs-params">()</span> <span class="hljs-title">bool</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> f.running.Load()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="避免可变全局变量"><a href="#避免可变全局变量" class="headerlink" title="避免可变全局变量"></a>避免可变全局变量</h3><p>使用选择依赖注入方式避免改变全局变量。<br>既适用于函数指针又适用于其他值类型</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// sign.go</span></span><br><span class="line"><span class="hljs-keyword">var</span> _timeNow = time.Now</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sign</span><span class="hljs-params">(msg <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  now := _timeNow()</span><br><span class="line">  <span class="hljs-keyword">return</span> signWithTime(msg, now)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// sign.go</span></span><br><span class="line"><span class="hljs-keyword">type</span> signer <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  now <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">time</span>.<span class="hljs-title">Time</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newSigner</span><span class="hljs-params">()</span> *<span class="hljs-title">signer</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> &amp;signer&#123;</span><br><span class="line">    now: time.Now,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *signer)</span> <span class="hljs-title">Sign</span><span class="hljs-params">(msg <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  now := s.now()</span><br><span class="line">  <span class="hljs-keyword">return</span> signWithTime(msg, now)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// sign_test.go</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSign</span><span class="hljs-params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  oldTimeNow := _timeNow</span><br><span class="line">  _timeNow = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">time</span>.<span class="hljs-title">Time</span></span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> someFixedTime</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; _timeNow = oldTimeNow &#125;()</span><br><span class="line">  assert.Equal(t, want, sign(give))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// sign_test.go</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestSigner</span><span class="hljs-params">(t *testing.T)</span></span> &#123;</span><br><span class="line">  s := newSigner()</span><br><span class="line">  s.now = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span> <span class="hljs-title">time</span>.<span class="hljs-title">Time</span></span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> someFixedTime</span><br><span class="line">  &#125;</span><br><span class="line">  assert.Equal(t, want, s.Sign(give))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="避免在公共结构中嵌入类型"><a href="#避免在公共结构中嵌入类型" class="headerlink" title="避免在公共结构中嵌入类型"></a>避免在公共结构中嵌入类型</h3><p>这些嵌入的类型泄漏实现细节、禁止类型演化和模糊的文档。</p>
<p>假设您使用共享的<code>AbstractList</code>实现了多种列表类型,请避免在具体的列表实现中嵌入<code>AbstractList</code>。<br>相反,只需手动将方法写入具体的列表,该列表将委托给抽象列表。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> AbstractList <span class="hljs-keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="hljs-comment">// 添加将实体添加到列表中。</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *AbstractList)</span> <span class="hljs-title">Add</span><span class="hljs-params">(e Entity)</span></span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 移除从列表中移除实体。</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *AbstractList)</span> <span class="hljs-title">Remove</span><span class="hljs-params">(e Entity)</span></span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// ConcreteList 是一个实体列表。</span></span><br><span class="line"><span class="hljs-keyword">type</span> ConcreteList <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  *AbstractList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// ConcreteList 是一个实体列表。</span></span><br><span class="line"><span class="hljs-keyword">type</span> ConcreteList <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  list *AbstractList</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 添加将实体添加到列表中。</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *ConcreteList)</span> <span class="hljs-title">Add</span><span class="hljs-params">(e Entity)</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> l.list.Add(e)</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 移除从列表中移除实体。</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *ConcreteList)</span> <span class="hljs-title">Remove</span><span class="hljs-params">(e Entity)</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> l.list.Remove(e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Go 允许 <a href="https://golang.org/doc/effective_go.html#embedding" target="_blank" rel="noopener">类型嵌入</a> 作为继承和组合之间的折衷。<br>外部类型获取嵌入类型的方法的隐式副本。<br>默认情况下,这些方法委托给嵌入实例的同一方法。</p>
<p>结构还获得与类型同名的字段。<br>所以,如果嵌入的类型是 public,那么字段是 public。为了保持向后兼容性,外部类型的每个未来版本都必须保留嵌入类型。</p>
<p>很少需要嵌入类型。<br>这是一种方便,可以帮助您避免编写冗长的委托方法。</p>
<p>即使嵌入兼容的抽象列表 <em>interface</em>,而不是结构体,这将为开发人员提供更大的灵活性来改变未来,但仍然泄露了具体列表使用抽象实现的细节。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// AbstractList 是各种实体列表的通用实现。</span></span><br><span class="line"><span class="hljs-keyword">type</span> AbstractList <span class="hljs-keyword">interface</span> &#123;</span><br><span class="line">  Add(Entity)</span><br><span class="line">  Remove(Entity)</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// ConcreteList 是一个实体列表。</span></span><br><span class="line"><span class="hljs-keyword">type</span> ConcreteList <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  AbstractList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// ConcreteList 是一个实体列表。</span></span><br><span class="line"><span class="hljs-keyword">type</span> ConcreteList <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  list *AbstractList</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 添加将实体添加到列表中。</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *ConcreteList)</span> <span class="hljs-title">Add</span><span class="hljs-params">(e Entity)</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> l.list.Add(e)</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 移除从列表中移除实体。</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *ConcreteList)</span> <span class="hljs-title">Remove</span><span class="hljs-params">(e Entity)</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> l.list.Remove(e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无论是使用嵌入式结构还是使用嵌入式接口,嵌入式类型都会限制类型的演化.</p>
<ul>
<li>向嵌入式接口添加方法是一个破坏性的改变。</li>
<li>删除嵌入类型是一个破坏性的改变。</li>
<li>即使使用满足相同接口的替代方法替换嵌入类型,也是一个破坏性的改变。</li>
</ul>
<p>尽管编写这些委托方法是乏味的,但是额外的工作隐藏了实现细节,留下了更多的更改机会,还消除了在文档中发现完整列表接口的间接性操作。</p>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><p>性能方面的特定准则只适用于高频场景。</p>
<h3 id="优先使用-strconv-而不是-fmt"><a href="#优先使用-strconv-而不是-fmt" class="headerlink" title="优先使用 strconv 而不是 fmt"></a>优先使用 strconv 而不是 fmt</h3><p>将原语转换为字符串或从字符串转换时,<code>strconv</code>速度比<code>fmt</code>快。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">  s := fmt.Sprint(rand.Int())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">  s := strconv.Itoa(rand.Int())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight angelscript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkFmtSprint<span class="hljs-number">-4</span>    <span class="hljs-number">143</span> ns/op    <span class="hljs-number">2</span> allocs/op</span><br></pre></td></tr></table></figure>
<figure class="highlight angelscript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkStrconv<span class="hljs-number">-4</span>    <span class="hljs-number">64.2</span> ns/op    <span class="hljs-number">1</span> allocs/op</span><br></pre></td></tr></table></figure>
<h3 id="避免字符串到字节的转换"><a href="#避免字符串到字节的转换" class="headerlink" title="避免字符串到字节的转换"></a>避免字符串到字节的转换</h3><p>不要反复从固定字符串创建字节 slice。相反,请执行一次转换并捕获结果。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">  w.Write([]<span class="hljs-keyword">byte</span>(<span class="hljs-string">"Hello world"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data := []<span class="hljs-keyword">byte</span>(<span class="hljs-string">"Hello world"</span>)</span><br><span class="line"><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">  w.Write(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight angelscript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkBad<span class="hljs-number">-4</span>   <span class="hljs-number">50000000</span>   <span class="hljs-number">22.2</span> ns/op</span><br></pre></td></tr></table></figure>
<figure class="highlight angelscript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BenchmarkGood<span class="hljs-number">-4</span>  <span class="hljs-number">500000000</span>   <span class="hljs-number">3.25</span> ns/op</span><br></pre></td></tr></table></figure>
<h3 id="尽量初始化时指定-Map-容量"><a href="#尽量初始化时指定-Map-容量" class="headerlink" title="尽量初始化时指定 Map 容量"></a>尽量初始化时指定 Map 容量</h3><p>在尽可能的情况下,在使用<code>make()</code>初始化的时候提供容量信息</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[T1]T2, hint)</span><br></pre></td></tr></table></figure>
<p>为<code>make()</code>提供容量信息（hint）尝试在初始化时调整 map 大小,<br>这减少了在将元素添加到 map 时增长和分配的开销。<br>注意,map 不能保证分配 hint 个容量。因此,即使提供了容量,添加元素仍然可以进行分配。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]os.FileInfo)</span><br><span class="line"></span><br><span class="line">files, _ := ioutil.ReadDir(<span class="hljs-string">"./files"</span>)</span><br><span class="line"><span class="hljs-keyword">for</span> _, f := <span class="hljs-keyword">range</span> files &#123;</span><br><span class="line">    m[f.Name()] = f</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">files, _ := ioutil.ReadDir(<span class="hljs-string">"./files"</span>)</span><br><span class="line"></span><br><span class="line">m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]os.FileInfo, <span class="hljs-built_in">len</span>(files))</span><br><span class="line"><span class="hljs-keyword">for</span> _, f := <span class="hljs-keyword">range</span> files &#123;</span><br><span class="line">    m[f.Name()] = f</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>m</code>是在没有大小提示的情况下创建的； 在运行时可能会有更多分配。</p>
<p><code>m</code>是有大小提示创建的；在运行时可能会有更少的分配。</p>
<h2 id="规范"><a href="#规范" class="headerlink" title="规范"></a>规范</h2><h3 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h3><p>本文中概述的一些标准都是客观性的评估,是根据场景、上下文、或者主观性的判断；</p>
<p>但是最重要的是,<strong>保持一致</strong>.</p>
<p>一致性的代码更容易维护、是更合理的、需要更少的学习成本、并且随着新的约定出现或者出现错误后更容易迁移、更新、修复 bug</p>
<p>相反,一个单一的代码库会导致维护成本开销、不确定性和认知偏差。所有这些都会直接导致速度降低、<br>代码审查痛苦、而且增加 bug 数量</p>
<p>将这些标准应用于代码库时,建议在 package（或更大）级别进行更改,子包级别的应用程序通过将多个样式引入到同一代码中,违反了上述关注点。</p>
<h3 id="相似的声明放在一组"><a href="#相似的声明放在一组" class="headerlink" title="相似的声明放在一组"></a>相似的声明放在一组</h3><p>Go 语言支持将相似的声明放在一个组内。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-string">"a"</span></span><br><span class="line"><span class="hljs-keyword">import</span> <span class="hljs-string">"b"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">  <span class="hljs-string">"a"</span></span><br><span class="line">  <span class="hljs-string">"b"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这同样适用于常量、变量和类型声明：</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-keyword">const</span> b = <span class="hljs-number">2</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-keyword">var</span> b = <span class="hljs-number">2</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> Area <span class="hljs-keyword">float64</span></span><br><span class="line"><span class="hljs-keyword">type</span> Volume <span class="hljs-keyword">float64</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  a = <span class="hljs-number">1</span></span><br><span class="line">  b = <span class="hljs-number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> (</span><br><span class="line">  a = <span class="hljs-number">1</span></span><br><span class="line">  b = <span class="hljs-number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> (</span><br><span class="line">  Area <span class="hljs-keyword">float64</span></span><br><span class="line">  Volume <span class="hljs-keyword">float64</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>仅将相关的声明放在一组。不要将不相关的声明放在一组。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Operation <span class="hljs-keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  Add Operation = <span class="hljs-literal">iota</span> + <span class="hljs-number">1</span></span><br><span class="line">  Subtract</span><br><span class="line">  Multiply</span><br><span class="line">  ENV_VAR = <span class="hljs-string">"MY_ENV"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Operation <span class="hljs-keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  Add Operation = <span class="hljs-literal">iota</span> + <span class="hljs-number">1</span></span><br><span class="line">  Subtract</span><br><span class="line">  Multiply</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> ENV_VAR = <span class="hljs-string">"MY_ENV"</span></span><br></pre></td></tr></table></figure>
<p>分组使用的位置没有限制,例如：你可以在函数内部使用它们：</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> red = color.New(<span class="hljs-number">0xff0000</span>)</span><br><span class="line">  <span class="hljs-keyword">var</span> green = color.New(<span class="hljs-number">0x00ff00</span>)</span><br><span class="line">  <span class="hljs-keyword">var</span> blue = color.New(<span class="hljs-number">0x0000ff</span>)</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> (</span><br><span class="line">    red   = color.New(<span class="hljs-number">0xff0000</span>)</span><br><span class="line">    green = color.New(<span class="hljs-number">0x00ff00</span>)</span><br><span class="line">    blue  = color.New(<span class="hljs-number">0x0000ff</span>)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="import-分组"><a href="#import-分组" class="headerlink" title="import 分组"></a>import 分组</h3><p>导入应该分为两组：</p>
<ul>
<li>标准库</li>
<li>其他库</li>
</ul>
<p>默认情况下,这是 goimports 应用的分组。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">  <span class="hljs-string">"fmt"</span></span><br><span class="line">  <span class="hljs-string">"os"</span></span><br><span class="line">  <span class="hljs-string">"go.uber.org/atomic"</span></span><br><span class="line">  <span class="hljs-string">"golang.org/x/sync/errgroup"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">  <span class="hljs-string">"fmt"</span></span><br><span class="line">  <span class="hljs-string">"os"</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-string">"go.uber.org/atomic"</span></span><br><span class="line">  <span class="hljs-string">"golang.org/x/sync/errgroup"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="包名"><a href="#包名" class="headerlink" title="包名"></a>包名</h3><p>当命名包时,请按下面规则选择一个名称：</p>
<ul>
<li>全部小写。没有大写或下划线。</li>
<li>大多数使用命名导入的情况下,不需要重命名。</li>
<li>简短而简洁。请记住,在每个使用的地方都完整标识了该名称。</li>
<li>不用复数。例如<code>net/url</code>,而不是<code>net/urls</code>。</li>
<li>不要用“common”,“util”,“shared”或“lib”。这些是不好的,信息量不足的名称。</li>
</ul>
<p>另请参阅 <a href="https://blog.golang.org/package-names" target="_blank" rel="noopener">Package Names</a> 和 <a href="https://rakyll.org/style-packages/" target="_blank" rel="noopener">Go 包样式指南</a>.</p>
<h3 id="函数名"><a href="#函数名" class="headerlink" title="函数名"></a>函数名</h3><p>我们遵循 Go 社区关于使用 <a href="https://golang.org/doc/effective_go.html#mixed-caps" target="_blank" rel="noopener">MixedCaps 作为函数名</a> 的约定。有一个例外,为了对相关的测试用例进行分组,函数名可能包含下划线,如：<code>TestMyFunction_WhatIsBeingTested</code>.</p>
<h3 id="导入别名"><a href="#导入别名" class="headerlink" title="导入别名"></a>导入别名</h3><p>如果程序包名称与导入路径的最后一个元素不匹配,则必须使用导入别名。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">  <span class="hljs-string">"net/http"</span></span><br><span class="line"></span><br><span class="line">  client <span class="hljs-string">"example.com/client-go"</span></span><br><span class="line">  trace <span class="hljs-string">"example.com/trace/v2"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在所有其他情况下,除非导入之间有直接冲突,否则应避免导入别名。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">  <span class="hljs-string">"fmt"</span></span><br><span class="line">  <span class="hljs-string">"os"</span></span><br><span class="line"></span><br><span class="line">  nettrace <span class="hljs-string">"golang.net/x/trace"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">  <span class="hljs-string">"fmt"</span></span><br><span class="line">  <span class="hljs-string">"os"</span></span><br><span class="line">  <span class="hljs-string">"runtime/trace"</span></span><br><span class="line"></span><br><span class="line">  nettrace <span class="hljs-string">"golang.net/x/trace"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="函数分组与顺序"><a href="#函数分组与顺序" class="headerlink" title="函数分组与顺序"></a>函数分组与顺序</h3><ul>
<li>函数应按粗略的调用顺序排序。</li>
<li>同一文件中的函数应按接收者分组。</li>
</ul>
<p>因此,导出的函数应先出现在文件中,放在<code>struct</code>,<code>const</code>,<code>var</code>定义的后面。</p>
<p>在定义类型之后,但在接收者的其余方法之前,可能会出现一个<code>newXYZ()</code>/<code>NewXYZ()</code></p>
<p>由于函数是按接收者分组的,因此普通工具函数应在文件末尾出现。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *something)</span> <span class="hljs-title">Cost</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> calcCost(s.weights)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> something <span class="hljs-keyword">struct</span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calcCost</span><span class="hljs-params">(n []<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *something)</span> <span class="hljs-title">Stop</span><span class="hljs-params">()</span></span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newSomething</span><span class="hljs-params">()</span> *<span class="hljs-title">something</span></span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> &amp;something&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> something <span class="hljs-keyword">struct</span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newSomething</span><span class="hljs-params">()</span> *<span class="hljs-title">something</span></span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> &amp;something&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *something)</span> <span class="hljs-title">Cost</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> calcCost(s.weights)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *something)</span> <span class="hljs-title">Stop</span><span class="hljs-params">()</span></span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calcCost</span><span class="hljs-params">(n []<span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;...&#125;</span><br></pre></td></tr></table></figure>
<h3 id="减少嵌套"><a href="#减少嵌套" class="headerlink" title="减少嵌套"></a>减少嵌套</h3><p>代码应通过尽可能先处理错误情况/特殊情况并尽早返回或继续循环来减少嵌套。减少嵌套多个级别的代码的代码量。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> data &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> v.F1 == <span class="hljs-number">1</span> &#123;</span><br><span class="line">    v = process(v)</span><br><span class="line">    <span class="hljs-keyword">if</span> err := v.Call(); err == <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">      v.Send()</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    log.Printf(<span class="hljs-string">"Invalid v: %v"</span>, v)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> data &#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> v.F1 != <span class="hljs-number">1</span> &#123;</span><br><span class="line">    log.Printf(<span class="hljs-string">"Invalid v: %v"</span>, v)</span><br><span class="line">    <span class="hljs-keyword">continue</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  v = process(v)</span><br><span class="line">  <span class="hljs-keyword">if</span> err := v.Call(); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line">  v.Send()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="不必要的-else"><a href="#不必要的-else" class="headerlink" title="不必要的 else"></a>不必要的 else</h3><p>如果在 if 的两个分支中都设置了变量,则可以将其替换为单个 if。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> a <span class="hljs-keyword">int</span></span><br><span class="line"><span class="hljs-keyword">if</span> b &#123;</span><br><span class="line">  a = <span class="hljs-number">100</span></span><br><span class="line">&#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">  a = <span class="hljs-number">10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-keyword">if</span> b &#123;</span><br><span class="line">  a = <span class="hljs-number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="顶层变量声明"><a href="#顶层变量声明" class="headerlink" title="顶层变量声明"></a>顶层变量声明</h3><p>在顶层,使用标准<code>var</code>关键字。请勿指定类型,除非它与表达式的类型不同。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> _s <span class="hljs-keyword">string</span> = F()</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">F</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span> &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> _s = F()</span><br><span class="line"><span class="hljs-comment">// 由于 F 已经明确了返回一个字符串类型,因此我们没有必要显式指定_s 的类型</span></span><br><span class="line"><span class="hljs-comment">// 还是那种类型</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">F</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span> &#125;</span><br></pre></td></tr></table></figure>
<p>如果表达式的类型与所需的类型不完全匹配,请指定类型。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> myError <span class="hljs-keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(myError)</span> <span class="hljs-title">Error</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">"error"</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">F</span><span class="hljs-params">()</span> <span class="hljs-title">myError</span></span> &#123; <span class="hljs-keyword">return</span> myError&#123;&#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> _e error = F()</span><br><span class="line"><span class="hljs-comment">// F 返回一个 myError 类型的实例,但是我们要 error 类型</span></span><br></pre></td></tr></table></figure>
<h3 id="对于未导出的顶层常量和变量-使用-作为前缀"><a href="#对于未导出的顶层常量和变量-使用-作为前缀" class="headerlink" title="对于未导出的顶层常量和变量,使用_作为前缀"></a>对于未导出的顶层常量和变量,使用_作为前缀</h3><p>在未导出的顶级<code>vars</code>和<code>consts</code>, 前面加上前缀_,以使它们在使用时明确表示它们是全局符号。</p>
<p>例外：未导出的错误值,应以<code>err</code>开头。</p>
<p>基本依据：顶级变量和常量具有包范围作用域。使用通用名称可能很容易在其他文件中意外使用错误的值。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// foo.go</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  defaultPort = <span class="hljs-number">8080</span></span><br><span class="line">  defaultUser = <span class="hljs-string">"user"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// bar.go</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Bar</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line">  defaultPort := <span class="hljs-number">9090</span></span><br><span class="line">  ...</span><br><span class="line">  fmt.Println(<span class="hljs-string">"Default port"</span>, defaultPort)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// We will not see a compile error if the first line of</span></span><br><span class="line">  <span class="hljs-comment">// Bar() is deleted.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// foo.go</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  _defaultPort = <span class="hljs-number">8080</span></span><br><span class="line">  _defaultUser = <span class="hljs-string">"user"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="结构体中的嵌入"><a href="#结构体中的嵌入" class="headerlink" title="结构体中的嵌入"></a>结构体中的嵌入</h3><p>嵌入式类型（例如 mutex）应位于结构体内的字段列表的顶部,并且必须有一个空行将嵌入式字段与常规字段分隔开。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Client <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  version <span class="hljs-keyword">int</span></span><br><span class="line">  http.Client</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Client <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  http.Client</span><br><span class="line"></span><br><span class="line">  version <span class="hljs-keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用字段名初始化结构体"><a href="#使用字段名初始化结构体" class="headerlink" title="使用字段名初始化结构体"></a>使用字段名初始化结构体</h3><p>初始化结构体时,几乎始终应该指定字段名称。现在由 <a href="https://golang.org/cmd/vet/" target="_blank" rel="noopener"><code>go vet</code></a> 强制执行。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k := User&#123;<span class="hljs-string">"John"</span>, <span class="hljs-string">"Doe"</span>, <span class="hljs-literal">true</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k := User&#123;</span><br><span class="line">    FirstName: <span class="hljs-string">"John"</span>,</span><br><span class="line">    LastName: <span class="hljs-string">"Doe"</span>,</span><br><span class="line">    Admin: <span class="hljs-literal">true</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例外：如果有 3 个或更少的字段,则可以在测试表中省略字段名称。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tests := []<span class="hljs-keyword">struct</span>&#123;</span><br><span class="line">  op Operation</span><br><span class="line">  want <span class="hljs-keyword">string</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">  &#123;Add, <span class="hljs-string">"add"</span>&#125;,</span><br><span class="line">  &#123;Subtract, <span class="hljs-string">"subtract"</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="本地变量声明"><a href="#本地变量声明" class="headerlink" title="本地变量声明"></a>本地变量声明</h3><p>如果将变量明确设置为某个值,则应使用短变量声明形式 (<code>:=</code>)。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> s = <span class="hljs-string">"foo"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s := <span class="hljs-string">"foo"</span></span><br></pre></td></tr></table></figure>
<p>但是,在某些情况下,<code>var</code>使用关键字时默认值会更清晰。例如,声明空切片。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">(list []<span class="hljs-keyword">int</span>)</span></span> &#123;</span><br><span class="line">  filtered := []<span class="hljs-keyword">int</span>&#123;&#125;</span><br><span class="line">  <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> list &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> v &gt; <span class="hljs-number">10</span> &#123;</span><br><span class="line">      filtered = <span class="hljs-built_in">append</span>(filtered, v)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">(list []<span class="hljs-keyword">int</span>)</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> filtered []<span class="hljs-keyword">int</span></span><br><span class="line">  <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> list &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> v &gt; <span class="hljs-number">10</span> &#123;</span><br><span class="line">      filtered = <span class="hljs-built_in">append</span>(filtered, v)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="nil-是一个有效的-slice"><a href="#nil-是一个有效的-slice" class="headerlink" title="nil 是一个有效的 slice"></a>nil 是一个有效的 slice</h3><p><code>nil</code>是一个有效的长度为 0 的 slice,这意味着,</p>
<ul>
<li>您不应明确返回长度为零的切片。应该返回<code>nil</code>来代替。</li>
</ul>
<p>  <code>Bad</code> vs <code>Good</code></p>
  <figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> x == <span class="hljs-string">""</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> []<span class="hljs-keyword">int</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> x == <span class="hljs-string">""</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>要检查切片是否为空,请始终使用<code>len(s) == 0</code>。而非<code>nil</code>。</li>
</ul>
<p>  <code>Bad</code> vs <code>Good</code></p>
  <figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">(s []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">bool</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> s == <span class="hljs-literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">(s []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">bool</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(s) == <span class="hljs-number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>零值切片（用<code>var</code>声明的切片）可立即使用,无需调用<code>make()</code>创建。</li>
</ul>
<p>  <code>Bad</code> vs <code>Good</code></p>
  <figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nums := []<span class="hljs-keyword">int</span>&#123;&#125;</span><br><span class="line"><span class="hljs-comment">// or, nums := make([]int)</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> add1 &#123;</span><br><span class="line">  nums = <span class="hljs-built_in">append</span>(nums, <span class="hljs-number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> add2 &#123;</span><br><span class="line">  nums = <span class="hljs-built_in">append</span>(nums, <span class="hljs-number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> nums []<span class="hljs-keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> add1 &#123;</span><br><span class="line">  nums = <span class="hljs-built_in">append</span>(nums, <span class="hljs-number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> add2 &#123;</span><br><span class="line">  nums = <span class="hljs-built_in">append</span>(nums, <span class="hljs-number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小变量作用域"><a href="#小变量作用域" class="headerlink" title="小变量作用域"></a>小变量作用域</h3><p>如果有可能,尽量缩小变量作用范围。除非它与 <a href="#减少嵌套">减少嵌套</a>的规则冲突。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err := ioutil.WriteFile(name, data, <span class="hljs-number">0644</span>)</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line"> <span class="hljs-keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> err := ioutil.WriteFile(name, data, <span class="hljs-number">0644</span>); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line"> <span class="hljs-keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果需要在 if 之外使用函数调用的结果,则不应尝试缩小范围。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> data, err := ioutil.ReadFile(name); err == <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">  err = cfg.Decode(data)</span><br><span class="line">  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fmt.Println(cfg)</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span></span><br><span class="line">&#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">data, err := ioutil.ReadFile(name)</span><br><span class="line"><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">   <span class="hljs-keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> err := cfg.Decode(data); err != <span class="hljs-literal">nil</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(cfg)</span><br><span class="line"><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span></span><br></pre></td></tr></table></figure>
<h3 id="避免参数语义不明确-Avoid-Naked-Parameters"><a href="#避免参数语义不明确-Avoid-Naked-Parameters" class="headerlink" title="避免参数语义不明确(Avoid Naked Parameters)"></a>避免参数语义不明确(Avoid Naked Parameters)</h3><p>函数调用中的<code>意义不明确的参数</code>可能会损害可读性。当参数名称的含义不明显时,请为参数添加 C 样式注释 (<code>/* ... */</code>)</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// func printInfo(name string, isLocal, done bool)</span></span><br><span class="line"></span><br><span class="line">printInfo(<span class="hljs-string">"foo"</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// func printInfo(name string, isLocal, done bool)</span></span><br><span class="line"></span><br><span class="line">printInfo(<span class="hljs-string">"foo"</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/* isLocal */</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/* done */</span>)</span><br></pre></td></tr></table></figure>
<p>对于上面的示例代码,还有一种更好的处理方式是将上面的<code>bool</code>类型换成自定义类型。将来,该参数可以支持不仅仅局限于两个状态（true/false）。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> Region <span class="hljs-keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  UnknownRegion Region = <span class="hljs-literal">iota</span></span><br><span class="line">  Local</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> Status <span class="hljs-keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> (</span><br><span class="line">  StatusReady = <span class="hljs-literal">iota</span> + <span class="hljs-number">1</span></span><br><span class="line">  StatusDone</span><br><span class="line">  <span class="hljs-comment">// Maybe we will have a StatusInProgress in the future.</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printInfo</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, region Region, status Status)</span></span></span><br></pre></td></tr></table></figure>
<h3 id="使用原始字符串字面值-避免转义"><a href="#使用原始字符串字面值-避免转义" class="headerlink" title="使用原始字符串字面值,避免转义"></a>使用原始字符串字面值,避免转义</h3><p>Go 支持使用 <a href="https://golang.org/ref/spec#raw_string_lit" target="_blank" rel="noopener">原始字符串字面值</a>,也就是 “`” 来表示原生字符串,在需要转义的场景下,我们应该尽量使用这种方案来替换。</p>
<p>可以跨越多行并包含引号。使用这些字符串可以避免更难阅读的手工转义的字符串。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wantError := <span class="hljs-string">"unknown name:\"test\""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wantError :=<span class="hljs-string">`unknown error:"test"`</span></span><br></pre></td></tr></table></figure>
<h3 id="初始化-Struct-引用"><a href="#初始化-Struct-引用" class="headerlink" title="初始化 Struct 引用"></a>初始化 Struct 引用</h3><p>在初始化结构引用时,请使用<code>&amp;T{}</code>代替<code>new(T)</code>,以使其与结构体初始化一致。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sval := T&#123;Name: <span class="hljs-string">"foo"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// inconsistent</span></span><br><span class="line">sptr := <span class="hljs-built_in">new</span>(T)</span><br><span class="line">sptr.Name = <span class="hljs-string">"bar"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sval := T&#123;Name: <span class="hljs-string">"foo"</span>&#125;</span><br><span class="line"></span><br><span class="line">sptr := &amp;T&#123;Name: <span class="hljs-string">"bar"</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="初始化-Maps"><a href="#初始化-Maps" class="headerlink" title="初始化 Maps"></a>初始化 Maps</h3><p>对于空 map 请使用<code>make(..)</code>初始化, 并且 map 是通过编程方式填充的。<br>这使得 map 初始化在表现上不同于声明,并且它还可以方便地在 make 后添加大小提示。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> (</span><br><span class="line">  <span class="hljs-comment">// m1 读写安全;</span></span><br><span class="line">  <span class="hljs-comment">// m2 在写入时会 panic</span></span><br><span class="line">  m1 = <span class="hljs-keyword">map</span>[T1]T2&#123;&#125;</span><br><span class="line">  m2 <span class="hljs-keyword">map</span>[T1]T2</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> (</span><br><span class="line">  <span class="hljs-comment">// m1 读写安全;</span></span><br><span class="line">  <span class="hljs-comment">// m2 在写入时会 panic</span></span><br><span class="line">  m1 = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[T1]T2)</span><br><span class="line">  m2 <span class="hljs-keyword">map</span>[T1]T2</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>声明和初始化看起来非常相似的。</p>
<p>声明和初始化看起来差别非常大。</p>
<p>在尽可能的情况下,请在初始化时提供 map 容量大小,详细请看 <a href="#尽量初始化时指定-Map-容量">尽量初始化时指定 Map 容量</a>。</p>
<p>另外,如果 map 包含固定的元素列表,则使用 map literals(map 初始化列表) 初始化映射。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[T1]T2, <span class="hljs-number">3</span>)</span><br><span class="line">m[k1] = v1</span><br><span class="line">m[k2] = v2</span><br><span class="line">m[k3] = v3</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="hljs-keyword">map</span>[T1]T2&#123;</span><br><span class="line">  k1: v1,</span><br><span class="line">  k2: v2,</span><br><span class="line">  k3: v3,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基本准则是：在初始化时使用 map 初始化列表 来添加一组固定的元素。否则使用<code>make</code>(如果可以,请尽量指定 map 容量)。</p>
<h3 id="字符串-string-format"><a href="#字符串-string-format" class="headerlink" title="字符串 string format"></a>字符串 string format</h3><p>如果你在函数外声明<code>Printf</code>-style 函数的格式字符串,请将其设置为<code>const</code>常量。</p>
<p>这有助于<code>go vet</code>对格式字符串执行静态分析。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msg := <span class="hljs-string">"unexpected values %v, %v\n"</span></span><br><span class="line">fmt.Printf(msg, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> msg = <span class="hljs-string">"unexpected values %v, %v\n"</span></span><br><span class="line">fmt.Printf(msg, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>
<h3 id="命名-Printf-样式的函数"><a href="#命名-Printf-样式的函数" class="headerlink" title="命名 Printf 样式的函数"></a>命名 Printf 样式的函数</h3><p>声明<code>Printf</code>-style 函数时,请确保<code>go vet</code>可以检测到它并检查格式字符串。</p>
<p>这意味着您应尽可能使用预定义的<code>Printf</code>-style 函数名称。<code>go vet</code>将默认检查这些。有关更多信息,请参见 <a href="https://golang.org/cmd/vet/#hdr-Printf_family" target="_blank" rel="noopener">Printf 系列</a>。</p>
<p>如果不能使用预定义的名称,请以 f 结束选择的名称：<code>Wrapf</code>,而不是<code>Wrap</code>。<code>go vet</code>可以要求检查特定的 Printf 样式名称,但名称必须以<code>f</code>结尾。</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span><span class="hljs-bash"> go vet -printfuncs=wrapf,statusf</span></span><br></pre></td></tr></table></figure>
<p>另请参阅 <a href="https://kuzminva.wordpress.com/2017/11/07/go-vet-printf-family-check/" target="_blank" rel="noopener">go vet: Printf family check</a>.</p>
<h2 id="编程模式"><a href="#编程模式" class="headerlink" title="编程模式"></a>编程模式</h2><h3 id="表驱动测试"><a href="#表驱动测试" class="headerlink" title="表驱动测试"></a>表驱动测试</h3><p>当测试逻辑是重复的时候,通过  <a href="https://blog.golang.org/subtests" target="_blank" rel="noopener">subtests</a> 使用 table 驱动的方式编写 case 代码看上去会更简洁。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// func TestSplitHostPort(t *testing.T)</span></span><br><span class="line"></span><br><span class="line">host, port, err := net.SplitHostPort(<span class="hljs-string">"192.0.2.0:8000"</span>)</span><br><span class="line">require.NoError(t, err)</span><br><span class="line">assert.Equal(t, <span class="hljs-string">"192.0.2.0"</span>, host)</span><br><span class="line">assert.Equal(t, <span class="hljs-string">"8000"</span>, port)</span><br><span class="line"></span><br><span class="line">host, port, err = net.SplitHostPort(<span class="hljs-string">"192.0.2.0:http"</span>)</span><br><span class="line">require.NoError(t, err)</span><br><span class="line">assert.Equal(t, <span class="hljs-string">"192.0.2.0"</span>, host)</span><br><span class="line">assert.Equal(t, <span class="hljs-string">"http"</span>, port)</span><br><span class="line"></span><br><span class="line">host, port, err = net.SplitHostPort(<span class="hljs-string">":8000"</span>)</span><br><span class="line">require.NoError(t, err)</span><br><span class="line">assert.Equal(t, <span class="hljs-string">""</span>, host)</span><br><span class="line">assert.Equal(t, <span class="hljs-string">"8000"</span>, port)</span><br><span class="line"></span><br><span class="line">host, port, err = net.SplitHostPort(<span class="hljs-string">"1:8"</span>)</span><br><span class="line">require.NoError(t, err)</span><br><span class="line">assert.Equal(t, <span class="hljs-string">"1"</span>, host)</span><br><span class="line">assert.Equal(t, <span class="hljs-string">"8"</span>, port)</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// func TestSplitHostPort(t *testing.T)</span></span><br><span class="line"></span><br><span class="line">tests := []<span class="hljs-keyword">struct</span>&#123;</span><br><span class="line">  give     <span class="hljs-keyword">string</span></span><br><span class="line">  wantHost <span class="hljs-keyword">string</span></span><br><span class="line">  wantPort <span class="hljs-keyword">string</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    give:     <span class="hljs-string">"192.0.2.0:8000"</span>,</span><br><span class="line">    wantHost: <span class="hljs-string">"192.0.2.0"</span>,</span><br><span class="line">    wantPort: <span class="hljs-string">"8000"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    give:     <span class="hljs-string">"192.0.2.0:http"</span>,</span><br><span class="line">    wantHost: <span class="hljs-string">"192.0.2.0"</span>,</span><br><span class="line">    wantPort: <span class="hljs-string">"http"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    give:     <span class="hljs-string">":8000"</span>,</span><br><span class="line">    wantHost: <span class="hljs-string">""</span>,</span><br><span class="line">    wantPort: <span class="hljs-string">"8000"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    give:     <span class="hljs-string">"1:8"</span>,</span><br><span class="line">    wantHost: <span class="hljs-string">"1"</span>,</span><br><span class="line">    wantPort: <span class="hljs-string">"8"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;</span><br><span class="line">  t.Run(tt.give, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    host, port, err := net.SplitHostPort(tt.give)</span><br><span class="line">    require.NoError(t, err)</span><br><span class="line">    assert.Equal(t, tt.wantHost, host)</span><br><span class="line">    assert.Equal(t, tt.wantPort, port)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显,使用 test table 的方式在代码逻辑扩展的时候,比如新增 test case,都会显得更加的清晰。</p>
<p>我们遵循这样的约定：将结构体切片称为<code>tests</code>。 每个测试用例称为<code>tt</code>。此外,我们鼓励使用<code>give</code>和<code>want</code>前缀说明每个测试用例的输入和输出值。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tests := []<span class="hljs-keyword">struct</span>&#123;</span><br><span class="line">  give     <span class="hljs-keyword">string</span></span><br><span class="line">  wantHost <span class="hljs-keyword">string</span></span><br><span class="line">  wantPort <span class="hljs-keyword">string</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> _, tt := <span class="hljs-keyword">range</span> tests &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="功能选项"><a href="#功能选项" class="headerlink" title="功能选项"></a>功能选项</h3><p>功能选项是一种模式,您可以在其中声明一个不透明 Option 类型,该类型在某些内部结构中记录信息。您接受这些选项的可变编号,并根据内部结构上的选项记录的全部信息采取行动。</p>
<p>将此模式用于您需要扩展的构造函数和其他公共 API 中的可选参数,尤其是在这些功能上已经具有三个或更多参数的情况下。</p>
<p><code>Bad</code> vs <code>Good</code></p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// package db</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Open</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  addr <span class="hljs-keyword">string</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  cache <span class="hljs-keyword">bool</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  logger *zap.Logger</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">)</span> <span class="hljs-params">(*Connection, error)</span></span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// package db</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> Option <span class="hljs-keyword">interface</span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCache</span><span class="hljs-params">(c <span class="hljs-keyword">bool</span>)</span> <span class="hljs-title">Option</span></span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithLogger</span><span class="hljs-params">(log *zap.Logger)</span> <span class="hljs-title">Option</span></span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Open creates a connection.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Open</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  addr <span class="hljs-keyword">string</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  opts ...Option,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">)</span> <span class="hljs-params">(*Connection, error)</span></span> &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>必须始终提供缓存和记录器参数,即使用户希望使用默认值。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.Open(addr, db.DefaultCache, zap.NewNop())</span><br><span class="line">db.Open(addr, db.DefaultCache, log)</span><br><span class="line">db.Open(addr, <span class="hljs-literal">false</span> <span class="hljs-comment">/* cache */</span>, zap.NewNop())</span><br><span class="line">db.Open(addr, <span class="hljs-literal">false</span> <span class="hljs-comment">/* cache */</span>, log)</span><br></pre></td></tr></table></figure>
<p>只有在需要时才提供选项。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.Open(addr)</span><br><span class="line">db.Open(addr, db.WithLogger(log))</span><br><span class="line">db.Open(addr, db.WithCache(<span class="hljs-literal">false</span>))</span><br><span class="line">db.Open(</span><br><span class="line">  addr,</span><br><span class="line">  db.WithCache(<span class="hljs-literal">false</span>),</span><br><span class="line">  db.WithLogger(log),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>我们建议实现此模式的方法是使用一个<code>Option</code>接口,该接口保存一个未导出的方法,在一个未导出的<code>options</code>结构上记录选项。</p>
<figure class="highlight go hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> options <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  cache  <span class="hljs-keyword">bool</span></span><br><span class="line">  logger *zap.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> Option <span class="hljs-keyword">interface</span> &#123;</span><br><span class="line">  apply(*options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> cacheOption <span class="hljs-keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c cacheOption)</span> <span class="hljs-title">apply</span><span class="hljs-params">(opts *options)</span></span> &#123;</span><br><span class="line">  opts.cache = <span class="hljs-keyword">bool</span>(c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCache</span><span class="hljs-params">(c <span class="hljs-keyword">bool</span>)</span> <span class="hljs-title">Option</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> cacheOption(c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> loggerOption <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">  Log *zap.Logger</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l loggerOption)</span> <span class="hljs-title">apply</span><span class="hljs-params">(opts *options)</span></span> &#123;</span><br><span class="line">  opts.logger = l.Log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithLogger</span><span class="hljs-params">(log *zap.Logger)</span> <span class="hljs-title">Option</span></span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> loggerOption&#123;Log: log&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Open creates a connection.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Open</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  addr <span class="hljs-keyword">string</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  opts ...Option,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">)</span> <span class="hljs-params">(*Connection, error)</span></span> &#123;</span><br><span class="line">  options := options&#123;</span><br><span class="line">    cache:  defaultCache,</span><br><span class="line">    logger: zap.NewNop(),</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> _, o := <span class="hljs-keyword">range</span> opts &#123;</span><br><span class="line">    o.apply(&amp;options)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意: 还有一种使用闭包实现这个模式的方法,但是我们相信上面的模式为作者提供了更多的灵活性,并且更容易对用户进行调试和测试。特别是,在不可能进行比较的情况下它允许在测试和模拟中对选项进行比较。此外,它还允许选项实现其他接口,包括<code>fmt.Stringer</code>,允许用户读取选项的字符串表示形式。</p>
<p>还可以参考下面资料：</p>
<ul>
<li><a href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html" target="_blank" rel="noopener">Self-referential functions and the design of options</a></li>
<li><a href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis" target="_blank" rel="noopener">Functional options for friendly APIs</a></li>
</ul>
<!-- TODO: replace this with parameter structs and functional options, when to
use one vs other -->
<h2 id="Stargazers-over-time"><a href="#Stargazers-over-time" class="headerlink" title="Stargazers over time"></a>Stargazers over time</h2><p><a href="https://starchart.cc/xxjwxc/uber_go_guide_cn" target="_blank" rel="noopener"><img src="https://starchart.cc/xxjwxc/uber_go_guide_cn.svg" alt="Stargazers over time"></a></p>
<p><a href="https://github.com/uber-go/guide" target="_blank" rel="noopener">uber-go/guide</a> 的中文翻译</p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/" rel="tag">编程规范</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-info donate">
    <span class="icon is-small">
        <i class="fab fa-alipay"></i>
    </span>
    <span>支付宝</span>
    <div class="qrcode"><img src="//md.ulovecode.com/static/images/avatar/alipay_v1.jpg" alt="支付宝"></div>
</a>

                
                
<a class="button is-success donate">
    <span class="icon is-small">
        <i class="fab fa-weixin"></i>
    </span>
    <span>微信</span>
    <div class="qrcode"><img src="//md.ulovecode.com/static/images/avatar/wechatpay_v1.jpg" alt="微信"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2020/04/07/Go/%E6%88%91%E5%AF%B9%E4%BA%8EGolang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B8%AD%E4%B8%8D%E5%90%8C%E7%9A%84%E7%90%86%E8%A7%A3/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">我对于 Golang 设计模式中不同的理解</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2020/04/04/Algorithm/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/TOP-K%E9%97%AE%E9%A2%98%E7%9A%84%E7%BB%88%E6%9E%81%E7%AE%97%E6%B3%95-BFPRT%E7%AE%97%E6%B3%95/">
                <span class="level-item">TOP-K 问题的终极算法 - BFPRT 算法</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
    <div id="comment-container"></div>
`    <link rel="stylesheet" href="https://code.bdstatic.com/npm/gitalk@1.7.2/dist/gitalk.css">
    <script src="https://code.bdstatic.com/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>
    <script>
        var gitalk = new Gitalk({
            clientID: 'ceb3f7e3fadb589ca8f2',
            clientSecret: 'ab52c871230e4d10ee2c2b54a8f9681727302b4d',
            id: '4cbb3af55a0c0b4935b2ff01cc390360',
            repo: 'ulovecode.github.io',
            owner: 'ulovecode',
            admin: "ulovecode",
        })
        gitalk.render('comment-container')
    </script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="https://md.ulovecode.com/static/images/avatar/avatar_v1.jpg?imageView2/0/w/460/h/460" alt="Jovan">
                    
                    
                    <p class="is-size-4 is-block">
                        Jovan
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Keep moving.Don&#39;t settle.
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Shanghai，China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        52
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        14
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        27
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/ulovecode" target="_blank">
                follow</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/ulovecode">
                
                <i class="fab fa-github"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#版本">
        <span class="has-mr-6">1</span>
        <span>版本</span>
        </a></li><li>
        <a class="is-flex" href="#目录">
        <span class="has-mr-6">2</span>
        <span>目录</span>
        </a></li><li>
        <a class="is-flex" href="#介绍">
        <span class="has-mr-6">3</span>
        <span>介绍</span>
        </a></li><li>
        <a class="is-flex" href="#指导原则">
        <span class="has-mr-6">4</span>
        <span>指导原则</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#指向-interface-的指针">
        <span class="has-mr-6">4.1</span>
        <span>指向 interface 的指针</span>
        </a></li><li>
        <a class="is-flex" href="#Interface-合理性验证">
        <span class="has-mr-6">4.2</span>
        <span>Interface 合理性验证</span>
        </a></li><li>
        <a class="is-flex" href="#接收器-receiver-与接口">
        <span class="has-mr-6">4.3</span>
        <span>接收器 (receiver) 与接口</span>
        </a></li><li>
        <a class="is-flex" href="#零值-Mutex-是有效的">
        <span class="has-mr-6">4.4</span>
        <span>零值 Mutex 是有效的</span>
        </a></li><li>
        <a class="is-flex" href="#在边界处拷贝-Slices-和-Maps">
        <span class="has-mr-6">4.5</span>
        <span>在边界处拷贝 Slices 和 Maps</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#接收-Slices-和-Maps">
        <span class="has-mr-6">4.5.1</span>
        <span>接收 Slices 和 Maps</span>
        </a></li><li>
        <a class="is-flex" href="#返回-slices-或-maps">
        <span class="has-mr-6">4.5.2</span>
        <span>返回 slices 或 maps</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#使用-defer-释放资源">
        <span class="has-mr-6">4.6</span>
        <span>使用 defer 释放资源</span>
        </a></li><li>
        <a class="is-flex" href="#Channel-的-size-要么是-1-要么是无缓冲的">
        <span class="has-mr-6">4.7</span>
        <span>Channel 的 size 要么是 1,要么是无缓冲的</span>
        </a></li><li>
        <a class="is-flex" href="#枚举从-1-开始">
        <span class="has-mr-6">4.8</span>
        <span>枚举从 1 开始</span>
        </a></li><li>
        <a class="is-flex" href="#使用-time-处理时间">
        <span class="has-mr-6">4.9</span>
        <span>使用 time 处理时间</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#使用time-Time表达瞬时时间">
        <span class="has-mr-6">4.9.1</span>
        <span>使用time.Time表达瞬时时间</span>
        </a></li><li>
        <a class="is-flex" href="#使用time-Duration表达时间段">
        <span class="has-mr-6">4.9.2</span>
        <span>使用time.Duration表达时间段</span>
        </a></li><li>
        <a class="is-flex" href="#对外部系统使用time-Time和time-Duration">
        <span class="has-mr-6">4.9.3</span>
        <span>对外部系统使用time.Time和time.Duration</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#错误类型">
        <span class="has-mr-6">4.10</span>
        <span>错误类型</span>
        </a></li><li>
        <a class="is-flex" href="#错误包装-Error-Wrapping">
        <span class="has-mr-6">4.11</span>
        <span>错误包装 (Error Wrapping)</span>
        </a></li><li>
        <a class="is-flex" href="#处理类型断言失败">
        <span class="has-mr-6">4.12</span>
        <span>处理类型断言失败</span>
        </a></li><li>
        <a class="is-flex" href="#不要-panic">
        <span class="has-mr-6">4.13</span>
        <span>不要 panic</span>
        </a></li><li>
        <a class="is-flex" href="#使用-go-uber-org-atomic">
        <span class="has-mr-6">4.14</span>
        <span>使用 go.uber.org/atomic</span>
        </a></li><li>
        <a class="is-flex" href="#避免可变全局变量">
        <span class="has-mr-6">4.15</span>
        <span>避免可变全局变量</span>
        </a></li><li>
        <a class="is-flex" href="#避免在公共结构中嵌入类型">
        <span class="has-mr-6">4.16</span>
        <span>避免在公共结构中嵌入类型</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#性能">
        <span class="has-mr-6">5</span>
        <span>性能</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#优先使用-strconv-而不是-fmt">
        <span class="has-mr-6">5.1</span>
        <span>优先使用 strconv 而不是 fmt</span>
        </a></li><li>
        <a class="is-flex" href="#避免字符串到字节的转换">
        <span class="has-mr-6">5.2</span>
        <span>避免字符串到字节的转换</span>
        </a></li><li>
        <a class="is-flex" href="#尽量初始化时指定-Map-容量">
        <span class="has-mr-6">5.3</span>
        <span>尽量初始化时指定 Map 容量</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#规范">
        <span class="has-mr-6">6</span>
        <span>规范</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#一致性">
        <span class="has-mr-6">6.1</span>
        <span>一致性</span>
        </a></li><li>
        <a class="is-flex" href="#相似的声明放在一组">
        <span class="has-mr-6">6.2</span>
        <span>相似的声明放在一组</span>
        </a></li><li>
        <a class="is-flex" href="#import-分组">
        <span class="has-mr-6">6.3</span>
        <span>import 分组</span>
        </a></li><li>
        <a class="is-flex" href="#包名">
        <span class="has-mr-6">6.4</span>
        <span>包名</span>
        </a></li><li>
        <a class="is-flex" href="#函数名">
        <span class="has-mr-6">6.5</span>
        <span>函数名</span>
        </a></li><li>
        <a class="is-flex" href="#导入别名">
        <span class="has-mr-6">6.6</span>
        <span>导入别名</span>
        </a></li><li>
        <a class="is-flex" href="#函数分组与顺序">
        <span class="has-mr-6">6.7</span>
        <span>函数分组与顺序</span>
        </a></li><li>
        <a class="is-flex" href="#减少嵌套">
        <span class="has-mr-6">6.8</span>
        <span>减少嵌套</span>
        </a></li><li>
        <a class="is-flex" href="#不必要的-else">
        <span class="has-mr-6">6.9</span>
        <span>不必要的 else</span>
        </a></li><li>
        <a class="is-flex" href="#顶层变量声明">
        <span class="has-mr-6">6.10</span>
        <span>顶层变量声明</span>
        </a></li><li>
        <a class="is-flex" href="#对于未导出的顶层常量和变量-使用-作为前缀">
        <span class="has-mr-6">6.11</span>
        <span>对于未导出的顶层常量和变量,使用_作为前缀</span>
        </a></li><li>
        <a class="is-flex" href="#结构体中的嵌入">
        <span class="has-mr-6">6.12</span>
        <span>结构体中的嵌入</span>
        </a></li><li>
        <a class="is-flex" href="#使用字段名初始化结构体">
        <span class="has-mr-6">6.13</span>
        <span>使用字段名初始化结构体</span>
        </a></li><li>
        <a class="is-flex" href="#本地变量声明">
        <span class="has-mr-6">6.14</span>
        <span>本地变量声明</span>
        </a></li><li>
        <a class="is-flex" href="#nil-是一个有效的-slice">
        <span class="has-mr-6">6.15</span>
        <span>nil 是一个有效的 slice</span>
        </a></li><li>
        <a class="is-flex" href="#小变量作用域">
        <span class="has-mr-6">6.16</span>
        <span>小变量作用域</span>
        </a></li><li>
        <a class="is-flex" href="#避免参数语义不明确-Avoid-Naked-Parameters">
        <span class="has-mr-6">6.17</span>
        <span>避免参数语义不明确(Avoid Naked Parameters)</span>
        </a></li><li>
        <a class="is-flex" href="#使用原始字符串字面值-避免转义">
        <span class="has-mr-6">6.18</span>
        <span>使用原始字符串字面值,避免转义</span>
        </a></li><li>
        <a class="is-flex" href="#初始化-Struct-引用">
        <span class="has-mr-6">6.19</span>
        <span>初始化 Struct 引用</span>
        </a></li><li>
        <a class="is-flex" href="#初始化-Maps">
        <span class="has-mr-6">6.20</span>
        <span>初始化 Maps</span>
        </a></li><li>
        <a class="is-flex" href="#字符串-string-format">
        <span class="has-mr-6">6.21</span>
        <span>字符串 string format</span>
        </a></li><li>
        <a class="is-flex" href="#命名-Printf-样式的函数">
        <span class="has-mr-6">6.22</span>
        <span>命名 Printf 样式的函数</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#编程模式">
        <span class="has-mr-6">7</span>
        <span>编程模式</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#表驱动测试">
        <span class="has-mr-6">7.1</span>
        <span>表驱动测试</span>
        </a></li><li>
        <a class="is-flex" href="#功能选项">
        <span class="has-mr-6">7.2</span>
        <span>功能选项</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#Stargazers-over-time">
        <span class="has-mr-6">8</span>
        <span>Stargazers over time</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
<!--                <a class="footer-logo is-block has-mb-6" href="/">-->
<!--                -->
<!--                    <img src="//md.ulovecode.com/static/images/avatar/logo.jpg" alt="(译) Uber Go 风格指南" height="28">-->
<!--                -->
<!--                </a>-->
<!--                <p class="is-size-7">-->
<!--                &copy; 2024 Jovan&nbsp;-->
<!--                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a-->
<!--                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>-->
<!--                -->
<!--                </p>-->
                <p class="is-size-7">
                    
                </p>
            </div>
<!--    备案号信息        -->
            <center>
            <a href="http://www.beian.miit.gov.cn/" target="_blank" style="color: rgba(0,0,0,0.65)"  noopenerrel="" > 鄂ICP备17027965号-1</a>
            </center>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>

<script> pangu.spacingPage();/* 这个是博客全局都进行自动加空格处理 */ </script>

    <script src="https://code.bdstatic.com/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://code.bdstatic.com/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    
    
    <script src="https://code.bdstatic.com/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://code.bdstatic.com/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://code.bdstatic.com/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://code.bdstatic.com/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>